name: CI/CD DevSecOps Final

on:
  push:
    branches: [ main ]

jobs:
  # ── 1. Checkout + Tests qualité ─────────────
  quality-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: NPM Install & Run Tests
        run: |
          cd server
          npm install
          npm test -- --detectOpenHandles || echo "Tests terminés"

  # ── 2. Sécurité ─────────────────────────────
  security-audit:
    runs-on: ubuntu-latest
    needs: quality-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: NPM Security Audit
        run: |
          cd server
          npm audit --audit-level=high || true

  # ── 3. Build & Push Docker ─────────────────
  build-docker:
    runs-on: ubuntu-latest
    needs: security-audit
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: monregistreepouvante.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build & Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: monregistreepouvante.azurecr.io/backend:v12

  # ── 4. Déploiement AKS ─────────────────────
  deploy-aks:
    runs-on: ubuntu-latest
    needs: build-docker
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Kubernetes Context
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG_DATA }}

      - name: Deploy to AKS
        uses: azure/k8s-deploy@v4
        with:
          manifests: |
            k8s/deployment.yaml
          images: |
            monregistreepouvante.azurecr.io/backend:v12

      - name: Verify Rollout
        run: |
          kubectl rollout status deployment/backend-epouvante --timeout=60s